<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Simple Setlist Management Tool - Viewer</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <main id="view">
      <div id="container">
        <div id="setting-area">
          <!-- プレイヤーボタンの表示・非表示 -->
          <div class="setting_layout">
            <div class="setting_heading">
              <h2>表示設定</h3>
              <p>各パーツの表示・非表示を切り替えます。</p>
            </div>
            
            <div class="setting_item item_checkbox">
              <p>プレイヤーボタン</p>
              <label class="toggle_button">
                <input type="checkbox" id="is-display-player" checked/>
              </label>
            </div>

            <div class="setting_item item_checkbox">
              <p>音声バー</p>
              <label class="toggle_button">
                <input type="checkbox" id="is-display-volume" checked/>
              </label>
            </div>

            <div class="setting_item item_checkbox">
              <p>オプションボタン</p>
              <label class="toggle_button">
                <input type="checkbox" id="is-display-option" checked/>
              </label>
            </div>
          </div>

          <div class="setting_layout">
            <div class="setting_heading">
              <h2>透過設定</h3>
              <p>各パーツの透過度を切り替えます。</p>
            </div>
            
            <div class="setting_item item_slider">
              <p>フレーム</p>
              <input type="range" id="input-range-frame" min="0" max="10" value="10">
            </div>

            <div class="setting_item item_slider">
              <p>コントローラー</p>
              <input type="range" id="input-range-controller" min="0" max="10" value="10">
            </div>
          </div>
        </div>

        <div id="character-area">
          <!-- セットリスト表示エリア -->
          <div class="set_list_area">
            <div id="set-list" class="set_list">
              <ol>
                <li>Fighting My Way</li>
                <li>Luna say maybe</li>
                <li>世界一可愛い私</li>
                <li>Fluorite</li>
                <li>白線</li>
                <li>Wonder Scale</li>
                <li>Fighting My Way</li>
                <li>Luna say maybe</li>
                <li>世界一可愛い私</li>
                <li>Fluorite</li>
                <li>白線</li>
                <li>Wonder Scale</li>
                <li>Fighting My Way</li>
                <li>Luna say maybe</li>
                <li>世界一可愛い私</li>
                <li>Fluorite</li>
                <li>白線</li>
                <li>Wonder Scale</li>
                <li>Fighting My Way</li>
                <li>Luna say maybe</li>
                <li>世界一可愛い私</li>
                <li>Fluorite</li>
                <li>白線</li>
                <li>Wonder Scale</li>
              </ol>
            </div>
          </div>
        </div>

        <div id="player-area">
          <!-- 楽曲情報 -->
          <div class="song_info_layout">
            <div class="song_info">
              <div class="scroll_container">
                <h1 class="scroll_item song_title">The Cute!!!</h1>
              </div>

              <div class="scroll_container">
                <p class="scroll_item song_artist">初星学園＆藤田ことね</p>
              </div>
            </div>

            <div class="song_buttons">
              <!-- お気に入りボタン -->
              <div class="favorite_button">
                <!-- <i class="fa-solid fa-star"></i> -->
                <i class="fa-regular fa-star"></i>
                <!-- <i class="fa-regular fa-thumbs-up"></i> -->
              </div>
              <!-- 三点リーダー -->
              <div class="more_button">
                <i class="fa-solid fa-ellipsis"></i>
              </div>
            </div>
          </div>

          <!-- 再生プログレスバー -->
          <div class="progress_bar">
            <div class="progress"></div>
          </div>

          <!-- コントロールバー -->
          <div id="control-bar">
            <!-- 1曲前に戻る -->
            <div class="control_button prev">
              <i class="fa-solid fa-backward"></i>
            </div>
            <!-- 再生・一時停止 -->
            <div class="control_button play">
              <i class="fa-solid fa-pause"></i>
            </div>
            <!-- 1曲先に進む -->
            <div class="control_button next">
              <i class="fa-solid fa-forward"></i>
            </div>
          </div>

          <!-- ボリューム -->
          <div id="volume-bar-layout">
            <div class="volume_button mute">
              <i class="fa-solid fa-volume-off"></i>
            </div>

            <div class="volume_bar">
              <div class="volume"></div>
            </div>

            <div class="volume_button max">
              <i class="fa-solid fa-volume-high"></i>
            </div>
          </div>

          <!-- オプション -->
          <div id="option-layout">
            <!-- 設定ボタン -->
            <div class="option_button setting_button">
              <i class="fa-solid fa-sliders"></i>
            </div>

            <!-- セットリスト読み込みボタン -->
            <div class="option_button plus_button">
              <i class="fa-solid fa-plus"></i>
              <input type="file" id="fileInput" accept=".txt" />
            </div>

            <!-- セットリスト表示ボタン -->
            <div class="option_button list_button">
              <i class="fa-solid fa-list-check"></i>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        /** ====================================================================== */
        /** 曲名が長いときにスクロールする処理 */
        /** ====================================================================== */
        function checkAndApplyScroll() {
          const scrollElements = document.querySelectorAll(".scroll_item");
          scrollElements.forEach((element) => {
            const container = element.parentElement;
            if (element.scrollWidth > container.clientWidth) {
              element.classList.add("is_scrolling");
            } else {
              element.classList.remove("is_scrolling");
            }
          });
        }
        checkAndApplyScroll();
        window.addEventListener("resize", checkAndApplyScroll);

        /** ====================================================================== */
        /** ローカルにあるセットリスト.txtを読み込みLocalStorageに保存する処理 */
        /** ====================================================================== */
        // .plus_buttonクリックでファイル選択
        document
          .querySelector(".plus_button")
          .addEventListener("click", function () {
            document.getElementById("fileInput").click();
          });

        // ファイル選択後、内容を読み込む
        document
          .getElementById("fileInput")
          .addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const text = e.target.result;
                // ここでtextの内容を[{title: string, artist: string},...}]の形式に変換する。
                const songs = text.split("\n").map((line) => {
                  const [title, artist] = line.split("@@");
                  return {
                    title: title.replace(/\r$/, ""),
                    artist: artist ? artist.replace(/\r$/, "") : "",
                  };
                });
                console.log(songs);

                // songsをローカルストレージに保存する。
                localStorage.setItem("songs", JSON.stringify(songs));
              };
              reader.readAsText(file, "UTF-8");
            }
          });

        /** ====================================================================== */
        /** セットリストを表示する処理 */
        /** ====================================================================== */
        document
          .querySelector(".list_button")
          .addEventListener("click", function () {
            const setListArea = document.querySelector(".set_list_area");
            if (setListArea.style.opacity === "1") {
              setListArea.style.opacity = "0";
              setListArea.style.visibility = "hidden";
            } else {
              setListArea.style.opacity = "1";
              setListArea.style.visibility = "visible";
            }
          });

        /** ====================================================================== */
        /** ローカルストレージにある歌唱済み曲のセットリストを表示する処理 */
        /** ====================================================================== */
        // const songs = JSON.parse(localStorage.getItem("songs"));
        // if (songs) {
        //   // 初期化
        //   const setList = document.getElementById("set-list");
        //   setList.innerHTML = ""; // 既存のリストをクリア

        //   // リストを作成する
        //   const ol = document.createElement("ol");
        //   songs.forEach((song) => {
        //     const li = document.createElement("li");
        //     li.textContent = song.title;
        //     ol.appendChild(li);
        //   });

        //   // リストをセットリストに追加
        //   setList.appendChild(ol);
        // }

        /** ====================================================================== */
        /** お気に入りボタンの切り替え処理 */
        /** ====================================================================== */
        document
          .querySelector(".favorite_button")
          .addEventListener("click", function () {
            const icon = this.querySelector("i");
            icon.classList.toggle("fa-regular");
            icon.classList.toggle("fa-solid");
          });

        /** ====================================================================== */
        /** セッティングを表示する処理 */
        /** ====================================================================== */
        const settingsArea = document.querySelector("#setting-area");

        // 設定パネルの表示・非表示を切り替える関数
        function toggleSettingsPanel() {
          const isVisible = settingsArea.style.opacity === "1";
          settingsArea.style.opacity = isVisible ? "0" : "1";
          settingsArea.style.visibility = isVisible ? "hidden" : "visible";
        }

        // 設定パネルを閉じる関数
        function closeSettingsPanel() {
          settingsArea.style.opacity = "0";
          settingsArea.style.visibility = "hidden";
        }

        // ボタンクリックで表示・非表示を切り替え
        document.querySelector(".setting_button").addEventListener("click", toggleSettingsPanel);

        // キーボードショートカットの設定
        document.addEventListener("keydown", function(event) {
          // input要素での入力中はショートカットを無効化
          if (event.target.tagName.toLowerCase() === 'input') {
            return;
          }

          // 's'キーで表示・非表示を切り替え
          if (event.key === 's') {
            toggleSettingsPanel();
          }

          // 'Escape'キーで非表示にする
          if (event.key === 'Escape') {
            closeSettingsPanel();
          }
        });

        /** ====================================================================== */
        /** 表示設定の保存・読み込みと表示切替 */
        /** ====================================================================== */
        function setupVisibilityToggle(checkboxId, elementSelector, storageKey) {
          const checkbox = document.getElementById(checkboxId);
          const element = document.querySelector(elementSelector);

          // HTML要素が見つからない場合はエラーを出力して終了
          if (!checkbox || !element) {
            console.error("表示切替用の要素が見つかりません:", { checkboxId, elementSelector });
            return;
          }

          // 表示状態を更新する関数
          function updateVisibility() {
            if (checkbox.checked) {
              element.style.display = ''; // 元の表示スタイルに戻す
            } else {
              element.style.display = 'none'; // 非表示にする
            }
          }

          // 1. ページ読み込み時にlocalStorageから設定を復元
          const savedValue = localStorage.getItem(storageKey);
          if (savedValue !== null) {
            checkbox.checked = savedValue === 'true';
          }

          // 2. 初期表示状態を更新
          updateVisibility();

          // 3. チェックボックスの変更を監視して、設定を保存し表示を更新
          checkbox.addEventListener('change', function() {
            localStorage.setItem(storageKey, this.checked);
            updateVisibility();
          });
        }

        // 各設定項目に対して、上記関数を実行
        setupVisibilityToggle('is-display-player', '#control-bar', 'isDisplayPlayer');
        setupVisibilityToggle('is-display-volume', '#volume-bar-layout', 'isDisplayVolume');
        setupVisibilityToggle('is-display-option', '#option-layout', 'isDisplayOption');

        /** ====================================================================== */
        /** 透過設定の保存・読み込みと反映 */
        /** ====================================================================== */
        function setupOpacitySlider(sliderId, elementSelector, storageKey, baseColorRgb, targetProperty) {
          const slider = document.getElementById(sliderId);
          const element = document.querySelector(elementSelector);

          if (!slider || !element) {
            console.error("透過設定用の要素が見つかりません:", { sliderId, elementSelector });
            return;
          }

          // 透過度を更新する関数
          function updateOpacity() {
            const opacity = slider.value / 10; // スライダーの値(0-10)を透過度(0.0-1.0)に変換
            element.style[targetProperty] = `rgba(${baseColorRgb}, ${opacity})`;
          }

          // 1. ページ読み込み時にlocalStorageから設定を復元
          const savedValue = localStorage.getItem(storageKey);
          if (savedValue !== null) {
            slider.value = savedValue;
          }

          // 2. 初期値を反映
          updateOpacity();

          // 3. スライダーの値が変更されたら、設定を保存し表示を更新
          slider.addEventListener('input', function() {
            localStorage.setItem(storageKey, this.value);
            updateOpacity();
          });
        }

        /**
         * CSS変数の値（例: #e8f7ff）を取得し、"R, G, B"形式の文字列に変換する関数
         * @param {string} cssVariable - CSS変数名 (例: '--main-color')
         * @returns {string} - "R, G, B" 形式の文字列 (例: "232, 247, 255")
         */
        function getRgbFromCssVar(cssVariable) {
          // CSS変数の値を取得
          const colorValue = getComputedStyle(document.documentElement).getPropertyValue(cssVariable).trim();
          
          // ブラウザに色計算をさせるため、一時的な要素を作成
          const tempElem = document.createElement('div');
          tempElem.style.color = colorValue;
          document.body.appendChild(tempElem);
          
          // 計算済みの 'rgb(r, g, b)' 形式の値を取得
          const computedColor = getComputedStyle(tempElem).color;
          
          // 一時的な要素をDOMから削除
          document.body.removeChild(tempElem);
          
          // "rgb(r, g, b)" の文字列から数値部分 "r, g, b" のみを抽出して返す
          return computedColor.match(/\d+/g).join(', ');
        }

        // '--main-color' の値を動的に取得
        const mainBaseColorRgb = getRgbFromCssVar('--main-color');

        // フレームのボーダー透過度に適用
        setupOpacitySlider('input-range-frame', '#character-area', 'frameOpacityValue', mainBaseColorRgb, 'borderColor');

        // コントローラー（プレイヤーエリア）の背景透過度に適用
        setupOpacitySlider('input-range-controller', '#player-area', 'controllerOpacityValue', mainBaseColorRgb, 'backgroundColor');
      });
    </script>
  </body>
</html>
